<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="generator" content="Jekyll v3.3.1">

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/css/main.css">
		<link rel="apple-touch-icon" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/images/favicon.png">

		<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Autonomous Collective Systems Laboratory" />
		<!-- Begin Jekyll SEO tag v2.0.0 -->
<title>pheeno_ros ROS Package Guide - Autonomous Collective Systems Laboratory</title>
<meta property="og:title" content="pheeno_ros ROS Package Guide" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="http://localhost:4000/ROS/pheeno-ros-guide/" />
<meta property="og:url" content="http://localhost:4000/ROS/pheeno-ros-guide/" />
<meta property="og:site_name" content="Autonomous Collective Systems Laboratory" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-12T22:22:13-04:00" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "pheeno_ros ROS Package Guide",
    "datePublished": "2017-06-12T22:22:13-04:00",
    "description": "Introduction",
    "logo": "http://localhost:4000/siteicon.png",
    "url": "http://localhost:4000/ROS/pheeno-ros-guide/"
  }
</script>
<!-- End Jekyll SEO tag -->

		
        
        
	</head>

	<body>
		<header>
			<h1>
				<a href="/"><img src="/images/emblem.svg" width="40" height="40" alt="Autonomous Collective Systems Laboratory logo"></a>
				Autonomous Collective Systems Laboratory
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>

			<form action="/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/">Welcome</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level current">
							
							<a href="/ROS/pheeno-ros-installation-guide/">ROS</a>
							<ul>
								
									<li class="nav-item "><a href="/ROS/pheeno-ros-installation-guide/">ROS Installation for Pheeno</a></li>
								
									<li class="nav-item current"><a href="/ROS/pheeno-ros-guide/">pheeno_ros ROS Package Guide</a></li>
								
									<li class="nav-item "><a href="/ROS/pheeno-ros-server-guide/">pheeno_ros_server ROS Package Guide</a></li>
								
									<li class="nav-item "><a href="/ROS/pheeno-ros-sim-guide/">pheeno_ros_sim ROS Package Guide</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/controls/pheeno-controller-guide/">Controls</a>
							<ul>
								
									<li class="nav-item "><a href="/controls/pheeno-controller-guide/">Controller for Pheeno Navigation</a></li>
								
									<li class="nav-item "><a href="/controls/pheeno-observer-guide/">Using Pheeno's for Reliable Feedback</a></li>
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/pheeno/pheeno_construction_content/">Pheeno</a>
							<ul>
								
									<li class="nav-item "><a href="/pheeno/pheeno_construction_content/">Pheeno Construction Guide</a></li>
								
									<li class="nav-item "><a href="/pheeno/raspberry_pi_content/">Setting Up Raspberry Pi with Camera for Pheeno</a></li>
								
									<li class="nav-item "><a href="/pheeno/pheeno_software_installation/">Pheeno Software Installation</a></li>
								
									<li class="nav-item "><a href="/pheeno/pheeno_programming_content/">Beginning to Program Pheeno</a></li>
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level ">
						
						<a href="/changelog/">Change Log</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>ROS</h2>
				<h3>pheeno_ros ROS Package Guide</h3>
			</div>
			<article class="content">
				<h2 id="introduction">Introduction</h2>

<p>The following guide will give a brief introduction to the use of the Robot Operating System with a single or multiple Pheenos.</p>

<h2 id="arduino-code">Arduino Code</h2>

<p><a href="ROS#pheeno-ros-installation-guide">Once ROS is installed on the Pheeno</a>, we can begin to set up the Pheeno to work with ROS. First, we need to upload the proper Arduino srcipt shown below.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="cp">#include &lt;ArduinoHardware.h&gt;
</span>    <span class="cp">#include &lt;ros.h&gt;
</span>    <span class="cp">#include &lt;std_msgs/Float32.h&gt;
</span>    <span class="cp">#include &lt;std_msgs/Int16.h&gt;
</span>    <span class="cp">#include &lt;geometry_msgs/Twist.h&gt;
</span>    <span class="cp">#include "PheenoV2Basic.h"
</span>
    <span class="c1">// Create ROS Node instance
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">;</span>


    <span class="c1">// Create Pheeno Instance
</span>    <span class="n">PheenoV2Basic</span> <span class="n">pheeno_robot</span> <span class="o">=</span> <span class="n">PheenoV2Basic</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>


    <span class="c1">// Create Messages for Publishers
</span>    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_center_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_back_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_right_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_left_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_cr_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_cl_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_LL_msg</span><span class="p">;</span>  <span class="c1">// Left HBridge, Left Motor Encoder
</span>    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_LR_msg</span><span class="p">;</span>  <span class="c1">// Left HBridge, Right Motor Encoder
</span>    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_RL_msg</span><span class="p">;</span>  <span class="c1">// Right HBridge, Left Motor Encoder
</span>    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_RR_msg</span><span class="p">;</span>  <span class="c1">// Right HBridge, Right Motor Encoder
</span>

    <span class="c1">// Create Variables for Storing Motion Data
</span>    <span class="kt">int</span> <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// Forward and Backward motion.
</span>    <span class="kt">int</span> <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Turning (Right and Left) motion.
</span>

    <span class="c1">// Create Publishers
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_center</span><span class="p">(</span><span class="s">"/scan_center"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_center_msg</span><span class="p">);</span>  <span class="c1">// Center IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_back</span><span class="p">(</span><span class="s">"/scan_back"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_back_msg</span><span class="p">);</span>        <span class="c1">// Back IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_right</span><span class="p">(</span><span class="s">"/scan_right"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_right_msg</span><span class="p">);</span>     <span class="c1">// Right IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_left</span><span class="p">(</span><span class="s">"/scan_left"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_left_msg</span><span class="p">);</span>        <span class="c1">// Left IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_cr</span><span class="p">(</span><span class="s">"/scan_cr"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cr_msg</span><span class="p">);</span>          <span class="c1">// Center Right IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_cl</span><span class="p">(</span><span class="s">"/scan_cl"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cl_msg</span><span class="p">);</span>          <span class="c1">// Center Left IR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_LL</span><span class="p">(</span><span class="s">"/encoder_LL"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_LL_msg</span><span class="p">);</span>  <span class="c1">// Encoder LL
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_LR</span><span class="p">(</span><span class="s">"/encoder_LR"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_LR_msg</span><span class="p">);</span>  <span class="c1">// Encoder LR
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_RL</span><span class="p">(</span><span class="s">"/encoder_RL"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_RL_msg</span><span class="p">);</span>  <span class="c1">// Encoder RL
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_RR</span><span class="p">(</span><span class="s">"/encoder_RR"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_RR_msg</span><span class="p">);</span>  <span class="c1">// Encoder RR
</span>

    <span class="c1">// Callback for cmd_vel Subscriber.
</span>    <span class="c1">// The following callback recieves a command in terms of m/s. This will have to
</span>    <span class="c1">// be converted into a binary output between 0-255.
</span>    <span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Twist</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">2550</span> <span class="o">*</span> <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">2550</span> <span class="o">*</span> <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span>

    <span class="p">}</span>


    <span class="c1">// Create Subscribers
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span> <span class="n">sub_cmd_vel</span><span class="p">(</span><span class="s">"cmd_vel"</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>


    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Setup Pheeno robot
</span>      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">SetupBasic</span><span class="p">();</span>

      <span class="c1">// Initialize ROS Node
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">initNode</span><span class="p">();</span>

      <span class="c1">// Start Advertising
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_center</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_back</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_right</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_left</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_cr</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_cl</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_LL</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_LR</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_RL</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_RR</span><span class="p">);</span>

      <span class="c1">// Start Subscribing
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">sub_cmd_vel</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

      <span class="c1">// Refresh Sensor Readings
</span>      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">readIR</span><span class="p">();</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">readEncoders</span><span class="p">();</span>

      <span class="c1">// Assign sensor values to Msg variable
</span>      <span class="n">scan_center_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">CDistance</span><span class="p">;</span>
      <span class="n">scan_back_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">BDistance</span><span class="p">;</span>
      <span class="n">scan_right_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">RDistance</span><span class="p">;</span>
      <span class="n">scan_left_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">LDistance</span><span class="p">;</span>
      <span class="n">scan_cr_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">RFDistance</span><span class="p">;</span>
      <span class="n">scan_cl_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">LFDistance</span><span class="p">;</span>
      <span class="n">encoder_LL_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountLL</span><span class="p">;</span>
      <span class="n">encoder_LR_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountLR</span><span class="p">;</span>
      <span class="n">encoder_RL_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountRL</span><span class="p">;</span>
      <span class="n">encoder_RR_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountRR</span><span class="p">;</span>

      <span class="c1">// Publish the Topics
</span>      <span class="n">pub_ir_center</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_center_msg</span><span class="p">);</span>
      <span class="n">pub_ir_back</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_back_msg</span><span class="p">);</span>
      <span class="n">pub_ir_right</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_right_msg</span><span class="p">);</span>
      <span class="n">pub_ir_left</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_left_msg</span><span class="p">);</span>
      <span class="n">pub_ir_cr</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_cr_msg</span><span class="p">);</span>
      <span class="n">pub_ir_cl</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_cl_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_LL</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_LL_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_LR</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_LR_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_RL</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_RL_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_RR</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_RR_msg</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">linear</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">linear</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">PheenoMoveForward</span><span class="p">(</span><span class="n">linear</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">PheenoMoveReverse</span><span class="p">(</span><span class="n">linear</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">angular</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">angular</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">PheenoTurnLeft</span><span class="p">(</span><span class="n">angular</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">PheenoTurnRight</span><span class="p">(</span><span class="n">angular</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">brakeAll</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="n">nh</span><span class="p">.</span><span class="n">spinOnce</span><span class="p">();</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>  <span class="c1">// Required because the Teensy sends messages too fast.
</span>
    <span class="p">}</span>


    <span class="c1">// Turns the Pheeno left.
</span>    <span class="c1">// Currently the appropriate use is just by providing a speed between 0-255,
</span>    <span class="c1">// without any error handling. Be careful!
</span>    <span class="kt">void</span> <span class="nf">PheenoTurnLeft</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">reverseRL</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">forwardLR</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="c1">// Turns the Pheeno Right.
</span>    <span class="c1">// Currently, the appropriate use is just by providing a speed between 0-255,
</span>    <span class="c1">// without any error handling. Be careful!
</span>    <span class="kt">void</span> <span class="nf">PheenoTurnRight</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">reverseLR</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">forwardRL</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="c1">// Moves the Pheeno Forward.
</span>    <span class="c1">// Applying a specific speed value (0-255) and both motors will apply the speed
</span>    <span class="c1">// without error handling. Be careful!
</span>    <span class="kt">void</span> <span class="nf">PheenoMoveForward</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">forwardLR</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">forwardRL</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

    <span class="p">}</span>


    <span class="c1">// Moves the Pheeno Reverse.
</span>    <span class="c1">// Applying a specific speed value (0-255) and both motors will apply the speed
</span>    <span class="c1">// without error handling. Be careful!
</span>    <span class="kt">void</span> <span class="nf">PheenoMoveReverse</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">reverseLR</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">reverseRL</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

    <span class="p">}</span>
</code></pre>
</div>

<p>We will go through the relevant parts of this Arduino script to help familiarize yourselves with how <code class="highlighter-rouge">rosserial_arduino</code> programs work. In our case, the Arduino script will function as a node that will subscribe to a <code class="highlighter-rouge">cmd_vel</code> input while simultaneously publishing encoder and IR sensor values.</p>

<h3 id="include-statements">Include Statements</h3>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="cp">#include &lt;ArduinoHardware.h&gt;
</span>    <span class="cp">#include &lt;ros.h&gt;
</span></code></pre>
</div>

<p>These two <code class="highlighter-rouge">include</code> statements are required to use ROS with the Arduino/Teensy. It contains packages for defining Nodes, Publishers, and Subscribers.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="cp">#include &lt;std_msgs/Float32.h&gt;
</span>    <span class="cp">#include &lt;std_msgs/Int16.h&gt;
</span>    <span class="cp">#include &lt;geometry_msgs/Twist.h&gt;
</span></code></pre>
</div>

<p>The next three <code class="highlighter-rouge">include</code> statements are for the message types we wish to use within this script. Currently, the IR Sensors are published with the <code class="highlighter-rouge">Float32</code> message type, the encoders are published with <code class="highlighter-rouge">Int16</code> message type, and we subscribe to the <code class="highlighter-rouge">cmd_vel</code> topic that uses the <code class="highlighter-rouge">Twist</code> message type. When wanting to add additional Publishers/Subscribers, you must add an <code class="highlighter-rouge">include</code> statement for each different message type you plan on using.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="cp">#include "PheenoV2Basic.h"
</span></code></pre>
</div>

<p>The last include statement is required to help initialize the Arduino/Teensy connection to the remainder of the Pheeno hardware.</p>

<h3 id="global-variables">Global Variables</h3>

<p>Typically, variables defined within this section are considered global variables within the Arduino/Teensy script. This is where we will define most of our variables relating to ROS.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create ROS Node instance
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">;</span>


    <span class="c1">// Create Pheeno Instance
</span>    <span class="n">PheenoV2Basic</span> <span class="n">pheeno_robot</span> <span class="o">=</span> <span class="n">PheenoV2Basic</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">rosserial_arduino</code> requires the instantiation of a ROS node that contains modules to advertise and subscribe our Publishers and Subscribers, respectively. In our case, the <code class="highlighter-rouge">nh</code> variable will serve as our ROS node. Creating an instance of <code class="highlighter-rouge">PheenoV2Basic</code> takes a variable 1 through 3 as options. You do not need to know what those other options are yet; however, we will discuss what those options mean in a different section.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create Messages for Publishers
</span>    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_center_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_back_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_right_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_left_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_cr_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Float32</span> <span class="n">scan_cl_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_LL_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_LR_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_RL_msg</span><span class="p">;</span>
    <span class="n">std_msgs</span><span class="o">::</span><span class="n">Int16</span> <span class="n">encoder_RR_msg</span><span class="p">;</span>
</code></pre>
</div>

<p>In our code, we create a message variables for the Publishers and Subscriber made later. The reason we use <code class="highlighter-rouge">Float32</code> and <code class="highlighter-rouge">Int16</code> is due to the hardware actually generating the readings with those types. Notice that we are using <code class="highlighter-rouge">std_msgs::</code> version of <code class="highlighter-rouge">Float32</code> and <code class="highlighter-rouge">Int16</code>. The ROS Publishers and Subscribers will only use variables that contain the ROS message wrapper, <em>i.e.</em> <code class="highlighter-rouge">std_msgs::</code>.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create Variables for Storing Motion Data
</span>    <span class="kt">int</span> <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// Forward and Backward motion.
</span>    <span class="kt">int</span> <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Turning (Right and Left) motion.
</span></code></pre>
</div>

<p>We will talk more about the use of these variables later, but, for now, we define the previous two variables.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create Publishers
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_center</span><span class="p">(</span><span class="s">"/scan_center"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_center_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_back</span><span class="p">(</span><span class="s">"/scan_back"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_back_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_right</span><span class="p">(</span><span class="s">"/scan_right"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_right_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_left</span><span class="p">(</span><span class="s">"/scan_left"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_left_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_cr</span><span class="p">(</span><span class="s">"/scan_cr"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cr_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_ir_cl</span><span class="p">(</span><span class="s">"/scan_cl"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cl_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_LL</span><span class="p">(</span><span class="s">"/encoder_LL"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_LL_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_LR</span><span class="p">(</span><span class="s">"/encoder_LR"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_LR_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_RL</span><span class="p">(</span><span class="s">"/encoder_RL"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_RL_msg</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_encoder_RR</span><span class="p">(</span><span class="s">"/encoder_RR"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder_RR_msg</span><span class="p">);</span>
</code></pre>
</div>

<p>Here we define our Publishers. Each publisher takes in two arguments. The first is the ROS Topic you would like to publish, and the second is the ROS message variable associated with the Topic. Note the use of an <code class="highlighter-rouge">&amp;</code> ahead of the variable. This means that the second argument is actually the <em>reference</em> to the ROS message variable.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create Subscribers
</span>    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span> <span class="n">sub_cmd_vel</span><span class="p">(</span><span class="s">"cmd_vel"</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
</code></pre>
</div>

<p>I skipped a couple lines, but will refer back to them in a second. Subscribers are defined slightly different from Publishers. As you can see, we need to specify within the type declaration that the recieved message will be a <code class="highlighter-rouge">geometry_msgs::Twist</code>. Just like in the Publisher, our first argument is the ROS message Topic; however, the second is a function! We refer to this as a <em>callback function</em>. Once the Publisher of a Topic publishes a message, the Subscriber will get the message and send it to the callback function for parsing (interpreting). The callback function used in this code is simply called <code class="highlighter-rouge">callback</code>. If you plan on adding more callback functions in the future, make sure to give them more specific names! It is not necessary to define the callback function before defining your Subscriber, but I do this for organizational purposes.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Callback for cmd_vel Subscriber.
</span>    <span class="c1">// The following callback recieves a command in terms of m/s. This will have to
</span>    <span class="c1">// be converted into a binary output between 0-255.
</span>    <span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Twist</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">2550</span> <span class="o">*</span> <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">linear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">2550</span> <span class="o">*</span> <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">angular</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span>

    <span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">callback</code> takes with it one argument: the Twist message’s reference. As seen above, dot operators can access a <code class="highlighter-rouge">msg</code> variables data. The specific path towards the data is dependent on the ROS message type. For <code class="highlighter-rouge">geometry_msgs::Twist</code>, we can access the information as such.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span>

    <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span>
</code></pre>
</div>

<p>For this differential drive robot, we will only be using <code class="highlighter-rouge">linear.x</code> and <code class="highlighter-rouge">angular.z</code>. We will use he former messages information to provide linear forward and backward motion while the later gives angular rotation about the z-axis of the robot. Why do we use only two?</p>

<p>Looking at the top of the Pheeno, imagine 3 vectors emanating from the pheeno: one from the center pointing forward, one from the center pointing out of the left side, and one from the center point vertically upwards. The distinction of <em>linear</em> means movement is in the direction of the vector. <code class="highlighter-rouge">linear.y</code> is not possible due to the fact that the robot is non-holonomic. The wheels cannot move the Pheeno to the left or right without turning! Unless the Pheeno has become equipped with a tiny jetpack, it won’t be able to move upwards either, so <code class="highlighter-rouge">linear.z</code> isn’t an option either.</p>

<p>Angular works differently. Instead of forward and backward motion from the vector, angular motion is rotation <em>about</em> the vector. Take out a pencil, if you have one. Put the eraser on a horizontal surface and have the tip pointing vertically. Now rotate in place. The eraser shouldn’t move and the pencil should stay in place. This is what we mean when we say rotating <em>about</em> an axis or vector. In the Pheeno’s case, the only axis that makes sense to rotate about is the z-axis. That is why we only need <code class="highlighter-rouge">angular.z</code>.</p>

<p>Going back to the code, the callback function assigns the subscribed value from the <code class="highlighter-rouge">cmd_vel</code> topic message to the linear and angular values.</p>

<h3 id="setup-function">Setup Function</h3>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Setup Pheeno robot
</span>      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">SetupBasic</span><span class="p">();</span>

      <span class="c1">// Initialize ROS Node
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">initNode</span><span class="p">();</span>

      <span class="c1">// Start Advertising
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_center</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_back</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_right</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_left</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_cr</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_ir_cl</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_LL</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_LR</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_RL</span><span class="p">);</span>
      <span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">pub_encoder_RR</span><span class="p">);</span>

      <span class="c1">// Start Subscribing
</span>      <span class="n">nh</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">sub_cmd_vel</span><span class="p">);</span>

    <span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">setup()</code> function of Arduino code is initialized every time the Arduino is powered on or reset. Therefore, every time the Arduino is reset (or powered on) the Pheeno must run the <code class="highlighter-rouge">SetupBasic()</code> and the <code class="highlighter-rouge">initNode()</code> methods. The first initializes the Pheeno for use, while the second method initializes the ROS node we wish to use. As a note, <strong>BOTH</strong> these statements must be present when attempting to write your own code for the Pheeno. Next, the node <code class="highlighter-rouge">nh</code> must advertise and subscribe the Publishers and Subscribers, respectively.</p>

<h3 id="loop-function">Loop Function</h3>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

      <span class="c1">// Refresh Sensor Readings
</span>      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">readIR</span><span class="p">();</span>
      <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">readEncoders</span><span class="p">();</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">loop()</code> function is repeated continuously until reset or a power cycle instance. Therefore, We will focus on this section because it is what allows interaction with ROS. At the beginning of every loop, we read both of our IR sensors and encoders.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>      <span class="c1">// Assign sensor values to Msg variable
</span>      <span class="n">scan_center_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">CDistance</span><span class="p">;</span>
      <span class="n">scan_back_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">BDistance</span><span class="p">;</span>
      <span class="n">scan_right_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">RDistance</span><span class="p">;</span>
      <span class="n">scan_left_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">LDistance</span><span class="p">;</span>
      <span class="n">scan_cr_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">RFDistance</span><span class="p">;</span>
      <span class="n">scan_cl_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">LFDistance</span><span class="p">;</span>
      <span class="n">encoder_LL_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountLL</span><span class="p">;</span>
      <span class="n">encoder_LR_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountLR</span><span class="p">;</span>
      <span class="n">encoder_RL_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountRL</span><span class="p">;</span>
      <span class="n">encoder_RR_msg</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">encoderCountRR</span><span class="p">;</span>
</code></pre>
</div>

<p>As I explained earlier for Twist messages, ROS data types are wrappers for the information that is sent. In the case of <code class="highlighter-rouge">std_msgs::Float32</code>, the variable is not <code class="highlighter-rouge">Float32</code>, but the variable has a parameter named <code class="highlighter-rouge">data</code> which <em>is</em> <code class="highlighter-rouge">Float32</code>. The values that come from the IR Sensor and Encoders are assigned to <code class="highlighter-rouge">variable_name.data</code> instead of just <code class="highlighter-rouge">variable_name</code>.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>      <span class="c1">// Publish the Topics
</span>      <span class="n">pub_ir_center</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_center_msg</span><span class="p">);</span>
      <span class="n">pub_ir_back</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_back_msg</span><span class="p">);</span>
      <span class="n">pub_ir_right</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_right_msg</span><span class="p">);</span>
      <span class="n">pub_ir_left</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_left_msg</span><span class="p">);</span>
      <span class="n">pub_ir_cr</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_cr_msg</span><span class="p">);</span>
      <span class="n">pub_ir_cl</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_cl_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_LL</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_LL_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_LR</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_LR_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_RL</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_RL_msg</span><span class="p">);</span>
      <span class="n">pub_encoder_RR</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder_RR_msg</span><span class="p">);</span>
</code></pre>
</div>

<p>After assigning the proper values from the hardware to the ROS Message variables, it is now time to publish those message in their respective ROS Topics. We use the <code class="highlighter-rouge">publish()</code> method for each Publisher to publish the messages we want. <strong>Remember</strong>, the argument must be the <em>reference</em> to the message variable.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>      <span class="k">if</span> <span class="p">(</span><span class="n">linear</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">linear</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">PheenoMoveForward</span><span class="p">(</span><span class="n">linear</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">PheenoMoveReverse</span><span class="p">(</span><span class="n">linear</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">angular</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">angular</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">PheenoTurnLeft</span><span class="p">(</span><span class="n">angular</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">PheenoTurnRight</span><span class="p">(</span><span class="n">angular</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pheeno_robot</span><span class="p">.</span><span class="n">brakeAll</span><span class="p">();</span>

      <span class="p">}</span>
</code></pre>
</div>

<p>After publishing, <code class="highlighter-rouge">linear</code> and <code class="highlighter-rouge">angular</code> variables are analyzed and movement assigned to the proper functions to move the Pheeno. The Pheeno will stop if either variable is set to zero.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code>      <span class="n">nh</span><span class="p">.</span><span class="n">spinOnce</span><span class="p">();</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>  <span class="c1">// Required because the Teensy sends messages too fast.
</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">spinOnce()</code> method gives control of the program to ROS for only <em>one</em> cycle, then lets go. ROS will only process callbacks if you use <code class="highlighter-rouge">spinOnce()</code>. Therefore, we must use it in our code if we want to receive information about the <code class="highlighter-rouge">cmd_vel</code> topic. This is how <code class="highlighter-rouge">rosserial_arduino</code> (and ROS C++ code) handles Subscribers within nodes. The <code class="highlighter-rouge">delay()</code> function following <code class="highlighter-rouge">spinOnce()</code> method serves to force the system to slow down slightly. If not present, errors about missing communications will occur when attempting to connect the Arduino/Teensy to the Pheeno’s Raspberry Pi</p>

<p>Once you have a good grasp of the information provided, upload the code to the Arduino/Teensy!</p>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
